//
//  ColorProfile.cpp
//  LCMS2
//
//  Created by Evgenij Lutz on 03.11.25.
//

#include <LCMS2C/ColorProfile.hpp>
#include <lcms2.h>


static char* fn_nonnull copyData(const void* fn_nonnull source fn_noescape, long size) {
    auto copy = new char[size];
    std::memcpy(copy, source, size);
    return copy;
}


LCMSColorProfile::LCMSColorProfile(const char* fn_nonnull data fn_noescape, long size):
_referenceCounter(1),
_data(data),
_size(size) {
    //
}


LCMSColorProfile::~LCMSColorProfile() {
    delete [] _data;
}


LCMSColorProfile* fn_nonnull LCMSColorProfile::create(const void* fn_nonnull data fn_noescape, long size) SWIFT_RETURNS_RETAINED {
    return new LCMSColorProfile(copyData(data, size), size);
}


LCMSColorProfile* fn_nonnull LCMSColorProfile::createSRGB() SWIFT_RETURNS_RETAINED {
    auto profile = cmsCreate_sRGBProfile();
    
    // Prepare for serialisation into memory
    cmsUInt32Number profileSize = 0;
    auto canSave = cmsSaveProfileToMem(profile, nullptr, &profileSize);
    if (canSave == false) {
        printf("Could not prepare ICC profile for serialisation\n");
        cmsCloseProfile(profile);
        return createRec709();
    }
    
    // Serialise into memory
    auto profileData = new char[profileSize];
    auto saved = cmsSaveProfileToMem(profile, profileData, &profileSize);
    if (saved == false) {
        printf("Could not serialize ICC profile\n");
        delete [] profileData;
        cmsCloseProfile(profile);
        return createRec709();
    }
    
    // Create profile
    auto sRGBProfile = LCMSColorProfile::create(profileData, profileSize);
    cmsCloseProfile(profile);
    
    return sRGBProfile;
}


LCMSColorProfile* fn_nonnull LCMSColorProfile::createRec709() SWIFT_RETURNS_RETAINED {
    static const unsigned char rec709Data[] = { 0x00, 0x00, 0x02, 0x54, 0x00, 0x00, 0x00, 0x00, 0x02, 0x00, 0x00, 0x00, 0x6D, 0x6E, 0x74, 0x72, 0x52, 0x47, 0x42, 0x20, 0x58, 0x59, 0x5A, 0x20, 0x07, 0xDB, 0x00, 0x02, 0x00, 0x10, 0x00, 0x12, 0x00, 0x1D, 0x00, 0x21, 0x61, 0x63, 0x73, 0x70, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x01, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0xF6, 0xD6, 0x00, 0x01, 0x00, 0x00, 0x00, 0x00, 0xD3, 0x2D, 0x00, 0x00, 0x00, 0x00, 0x6F, 0x72, 0x3A, 0x61, 0x57, 0x09, 0xAE, 0xA0, 0xE1, 0x65, 0x88, 0x4C, 0x20, 0x1D, 0x80, 0xE4, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x0B, 0x64, 0x65, 0x73, 0x63, 0x00, 0x00, 0x01, 0x08, 0x00, 0x00, 0x00, 0x79, 0x62, 0x58, 0x59, 0x5A, 0x00, 0x00, 0x01, 0x84, 0x00, 0x00, 0x00, 0x14, 0x62, 0x54, 0x52, 0x43, 0x00, 0x00, 0x01, 0x98, 0x00, 0x00, 0x00, 0x10, 0x67, 0x58, 0x59, 0x5A, 0x00, 0x00, 0x01, 0xA8, 0x00, 0x00, 0x00, 0x14, 0x67, 0x54, 0x52, 0x43, 0x00, 0x00, 0x01, 0x98, 0x00, 0x00, 0x00, 0x10, 0x72, 0x58, 0x59, 0x5A, 0x00, 0x00, 0x01, 0xBC, 0x00, 0x00, 0x00, 0x14, 0x72, 0x54, 0x52, 0x43, 0x00, 0x00, 0x01, 0x98, 0x00, 0x00, 0x00, 0x10, 0x74, 0x65, 0x63, 0x68, 0x00, 0x00, 0x01, 0xD0, 0x00, 0x00, 0x00, 0x0C, 0x77, 0x74, 0x70, 0x74, 0x00, 0x00, 0x01, 0xDC, 0x00, 0x00, 0x00, 0x14, 0x63, 0x70, 0x72, 0x74, 0x00, 0x00, 0x01, 0xF0, 0x00, 0x00, 0x00, 0x37, 0x63, 0x68, 0x61, 0x64, 0x00, 0x00, 0x02, 0x28, 0x00, 0x00, 0x00, 0x2C, 0x64, 0x65, 0x73, 0x63, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x1F, 0x49, 0x54, 0x55, 0x2D, 0x52, 0x20, 0x42, 0x54, 0x2E, 0x37, 0x30, 0x39, 0x20, 0x52, 0x65, 0x66, 0x65, 0x72, 0x65, 0x6E, 0x63, 0x65, 0x20, 0x44, 0x69, 0x73, 0x70, 0x6C, 0x61, 0x79, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x58, 0x59, 0x5A, 0x20, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x24, 0xA0, 0x00, 0x00, 0x0F, 0x84, 0x00, 0x00, 0xB6, 0xCF, 0x63, 0x75, 0x72, 0x76, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x01, 0x02, 0x66, 0x00, 0x00, 0x58, 0x59, 0x5A, 0x20, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x62, 0x99, 0x00, 0x00, 0xB7, 0x85, 0x00, 0x00, 0x18, 0xDA, 0x58, 0x59, 0x5A, 0x20, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x6F, 0xA2, 0x00, 0x00, 0x38, 0xF5, 0x00, 0x00, 0x03, 0x90, 0x73, 0x69, 0x67, 0x20, 0x00, 0x00, 0x00, 0x00, 0x43, 0x52, 0x54, 0x20, 0x58, 0x59, 0x5A, 0x20, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0xF6, 0xD6, 0x00, 0x01, 0x00, 0x00, 0x00, 0x00, 0xD3, 0x2D, 0x74, 0x65, 0x78, 0x74, 0x00, 0x00, 0x00, 0x00, 0x43, 0x6F, 0x70, 0x79, 0x72, 0x69, 0x67, 0x68, 0x74, 0x20, 0x49, 0x6E, 0x74, 0x65, 0x72, 0x6E, 0x61, 0x74, 0x69, 0x6F, 0x6E, 0x61, 0x6C, 0x20, 0x43, 0x6F, 0x6C, 0x6F, 0x72, 0x20, 0x43, 0x6F, 0x6E, 0x73, 0x6F, 0x72, 0x74, 0x69, 0x75, 0x6D, 0x2C, 0x20, 0x32, 0x30, 0x31, 0x31, 0x00, 0x00, 0x73, 0x66, 0x33, 0x32, 0x00, 0x00, 0x00, 0x00, 0x00, 0x01, 0x0C, 0x44, 0x00, 0x00, 0x05, 0xDF, 0xFF, 0xFF, 0xF3, 0x26, 0x00, 0x00, 0x07, 0x94, 0x00, 0x00, 0xFD, 0x8F, 0xFF, 0xFF, 0xFB, 0xA1, 0xFF, 0xFF, 0xFD, 0xA2, 0x00, 0x00, 0x03, 0xDB, 0x00, 0x00, 0xC0, 0x75 };
    
    return create(rec709Data, sizeof(rec709Data));
}


LCMSColorProfile* fn_nonnull LCMSColorProfile::createRec2020() SWIFT_RETURNS_RETAINED {
    static const unsigned char rec2020Data[] = {
        0x00, 0x00, 0x02, 0xDC, 0x41, 0x44, 0x42, 0x45, 0x04, 0x30, 0x00, 0x00, 0x6D, 0x6E, 0x74, 0x72, 0x52, 0x47, 0x42, 0x20, 0x58, 0x59, 0x5A, 0x20, 0x07, 0xE0, 0x00, 0x09, 0x00, 0x1D, 0x00, 0x12, 0x00, 0x0A, 0x00, 0x00, 0x61, 0x63, 0x73, 0x70, 0x4D, 0x53, 0x46, 0x54, 0x00, 0x00, 0x00, 0x00, 0x49, 0x54, 0x55, 0x20, 0x32, 0x30, 0x32, 0x30, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x01, 0x00, 0x00, 0xF6, 0xD6, 0x00, 0x01, 0x00, 0x00, 0x00, 0x00, 0xD3, 0x2D, 0x49, 0x43, 0x43, 0x20, 0xD2, 0xDD, 0x42, 0x64, 0x10, 0x7C, 0x8B, 0xB8, 0x84, 0xB9, 0xD7, 0xE6, 0xD4, 0x38, 0x4B, 0xA2, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x0D, 0x64, 0x65, 0x73, 0x63, 0x00, 0x00, 0x01, 0x20, 0x00, 0x00, 0x00, 0x5A, 0x63, 0x70, 0x72, 0x74, 0x00, 0x00, 0x01, 0x7C, 0x00, 0x00, 0x00, 0x7E, 0x77, 0x74, 0x70, 0x74, 0x00, 0x00, 0x01, 0xFC, 0x00, 0x00, 0x00, 0x14, 0x62, 0x6B, 0x70, 0x74, 0x00, 0x00, 0x02, 0x10, 0x00, 0x00, 0x00, 0x14, 0x72, 0x58, 0x59, 0x5A, 0x00, 0x00, 0x02, 0x24, 0x00, 0x00, 0x00, 0x14, 0x67, 0x58, 0x59, 0x5A, 0x00, 0x00, 0x02, 0x38, 0x00, 0x00, 0x00, 0x14, 0x62, 0x58, 0x59, 0x5A, 0x00, 0x00, 0x02, 0x4C, 0x00, 0x00, 0x00, 0x14, 0x6C, 0x75, 0x6D, 0x69, 0x00, 0x00, 0x02, 0x60, 0x00, 0x00, 0x00, 0x14, 0x74, 0x65, 0x63, 0x68, 0x00, 0x00, 0x02, 0x74, 0x00, 0x00, 0x00, 0x0C, 0x63, 0x68, 0x61, 0x64, 0x00, 0x00, 0x02, 0x80, 0x00, 0x00, 0x00, 0x2C, 0x72, 0x54, 0x52, 0x43, 0x00, 0x00, 0x02, 0xAC, 0x00, 0x00, 0x00, 0x10, 0x67, 0x54, 0x52, 0x43, 0x00, 0x00, 0x02, 0xBC, 0x00, 0x00, 0x00, 0x10, 0x62, 0x54, 0x52, 0x43, 0x00, 0x00, 0x02, 0xCC, 0x00, 0x00, 0x00, 0x10, 0x6D, 0x6C, 0x75, 0x63, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x01, 0x00, 0x00, 0x00, 0x0C, 0x65, 0x6E, 0x55, 0x53, 0x00, 0x00, 0x00, 0x3E, 0x00, 0x00, 0x00, 0x1C, 0x00, 0x49, 0x00, 0x54, 0x00, 0x55, 0x00, 0x2D, 0x00, 0x52, 0x00, 0x20, 0x00, 0x42, 0x00, 0x54, 0x00, 0x2E, 0x00, 0x32, 0x00, 0x30, 0x00, 0x32, 0x00, 0x30, 0x00, 0x20, 0x00, 0x52, 0x00, 0x65, 0x00, 0x66, 0x00, 0x65, 0x00, 0x72, 0x00, 0x65, 0x00, 0x6E, 0x00, 0x63, 0x00, 0x65, 0x00, 0x20, 0x00, 0x44, 0x00, 0x69, 0x00, 0x73, 0x00, 0x70, 0x00, 0x6C, 0x00, 0x61, 0x00, 0x79, 0x00, 0x00, 0x6D, 0x6C, 0x75, 0x63, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x01, 0x00, 0x00, 0x00, 0x0C, 0x65, 0x6E, 0x55, 0x53, 0x00, 0x00, 0x00, 0x62, 0x00, 0x00, 0x00, 0x1C, 0x00, 0x43, 0x00, 0x6F, 0x00, 0x70, 0x00, 0x79, 0x00, 0x72, 0x00, 0x69, 0x00, 0x67, 0x00, 0x68, 0x00, 0x74, 0x00, 0x20, 0x00, 0x28, 0x00, 0x63, 0x00, 0x29, 0x00, 0x20, 0x00, 0x32, 0x00, 0x30, 0x00, 0x31, 0x00, 0x36, 0x00, 0x20, 0x00, 0x49, 0x00, 0x6E, 0x00, 0x74, 0x00, 0x65, 0x00, 0x72, 0x00, 0x6E, 0x00, 0x61, 0x00, 0x74, 0x00, 0x69, 0x00, 0x6F, 0x00, 0x6E, 0x00, 0x61, 0x00, 0x6C, 0x00, 0x20, 0x00, 0x43, 0x00, 0x6F, 0x00, 0x6C, 0x00, 0x6F, 0x00, 0x72, 0x00, 0x20, 0x00, 0x43, 0x00, 0x6F, 0x00, 0x6E, 0x00, 0x73, 0x00, 0x6F, 0x00, 0x72, 0x00, 0x74, 0x00, 0x69, 0x00, 0x75, 0x00, 0x6D, 0x00, 0x00, 0x58, 0x59, 0x5A, 0x20, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0xF6, 0xD6, 0x00, 0x01, 0x00, 0x00, 0x00, 0x00, 0xD3, 0x2D, 0x58, 0x59, 0x5A, 0x20, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x58, 0x59, 0x5A, 0x20, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0xAC, 0x67, 0x00, 0x00, 0x47, 0x6E, 0xFF, 0xFF, 0xFF, 0x81, 0x58, 0x59, 0x5A, 0x20, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x2A, 0x68, 0x00, 0x00, 0xAC, 0xE4, 0x00, 0x00, 0x07, 0xAD, 0x58, 0x59, 0x5A, 0x20, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x20, 0x03, 0x00, 0x00, 0x0B, 0xAD, 0x00, 0x00, 0xCC, 0x01, 0x58, 0x59, 0x5A, 0x20, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x64, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x73, 0x69, 0x67, 0x20, 0x00, 0x00, 0x00, 0x00, 0x76, 0x69, 0x64, 0x6D, 0x73, 0x66, 0x33, 0x32, 0x00, 0x00, 0x00, 0x00, 0x00, 0x01, 0x0C, 0x42, 0x00, 0x00, 0x05, 0xDE, 0xFF, 0xFF, 0xF3, 0x25, 0x00, 0x00, 0x07, 0x93, 0x00, 0x00, 0xFD, 0x90, 0xFF, 0xFF, 0xFB, 0xA1, 0xFF, 0xFF, 0xFD, 0xA2, 0x00, 0x00, 0x03, 0xDC, 0x00, 0x00, 0xC0, 0x6E, 0x70, 0x61, 0x72, 0x61, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x02, 0x66, 0x66, 0x70, 0x61, 0x72, 0x61, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x02, 0x66, 0x66, 0x70, 0x61, 0x72, 0x61, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x02, 0x66, 0x66 };
    
    return create(rec2020Data, sizeof(rec2020Data));
}


LCMSColorProfile* fn_nonnull LCMSColorProfile::createDCIP3() SWIFT_RETURNS_RETAINED {
    static const unsigned char dciP3Data[] = { 0x00, 0x00, 0x02, 0x5C, 0x00, 0x00, 0x00, 0x00, 0x04, 0x30, 0x00, 0x00, 0x6D, 0x6E, 0x74, 0x72, 0x52, 0x47, 0x42, 0x20, 0x58, 0x59, 0x5A, 0x20, 0x07, 0xE1, 0x00, 0x06, 0x00, 0x14, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x61, 0x63, 0x73, 0x70, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x01, 0x00, 0x00, 0xF6, 0xD6, 0x00, 0x01, 0x00, 0x00, 0x00, 0x00, 0xD3, 0x2D, 0x43, 0x49, 0x47, 0x4C, 0xC5, 0x09, 0xF0, 0x89, 0xDF, 0x32, 0x77, 0xB1, 0xB1, 0x61, 0x31, 0x7B, 0x35, 0x9C, 0x7C, 0xD9, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x0B, 0x63, 0x70, 0x72, 0x74, 0x00, 0x00, 0x01, 0x08, 0x00, 0x00, 0x00, 0x64, 0x64, 0x65, 0x73, 0x63, 0x00, 0x00, 0x01, 0x6C, 0x00, 0x00, 0x00, 0x30, 0x77, 0x74, 0x70, 0x74, 0x00, 0x00, 0x01, 0x9C, 0x00, 0x00, 0x00, 0x14, 0x63, 0x68, 0x61, 0x64, 0x00, 0x00, 0x01, 0xB0, 0x00, 0x00, 0x00, 0x2C, 0x72, 0x54, 0x52, 0x43, 0x00, 0x00, 0x01, 0xDC, 0x00, 0x00, 0x00, 0x10, 0x67, 0x54, 0x52, 0x43, 0x00, 0x00, 0x01, 0xEC, 0x00, 0x00, 0x00, 0x10, 0x62, 0x54, 0x52, 0x43, 0x00, 0x00, 0x01, 0xFC, 0x00, 0x00, 0x00, 0x10, 0x72, 0x58, 0x59, 0x5A, 0x00, 0x00, 0x02, 0x0C, 0x00, 0x00, 0x00, 0x14, 0x67, 0x58, 0x59, 0x5A, 0x00, 0x00, 0x02, 0x20, 0x00, 0x00, 0x00, 0x14, 0x62, 0x58, 0x59, 0x5A, 0x00, 0x00, 0x02, 0x34, 0x00, 0x00, 0x00, 0x14, 0x6C, 0x75, 0x6D, 0x69, 0x00, 0x00, 0x02, 0x48, 0x00, 0x00, 0x00, 0x14, 0x6D, 0x6C, 0x75, 0x63, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x01, 0x00, 0x00, 0x00, 0x0C, 0x65, 0x6E, 0x55, 0x4B, 0x00, 0x00, 0x00, 0x48, 0x00, 0x00, 0x00, 0x1C, 0x00, 0x49, 0x00, 0x6E, 0x00, 0x74, 0x00, 0x65, 0x00, 0x72, 0x00, 0x6E, 0x00, 0x61, 0x00, 0x74, 0x00, 0x69, 0x00, 0x6F, 0x00, 0x6E, 0x00, 0x61, 0x00, 0x6C, 0x00, 0x20, 0x00, 0x43, 0x00, 0x6F, 0x00, 0x6C, 0x00, 0x6F, 0x00, 0x72, 0x00, 0x20, 0x00, 0x43, 0x00, 0x6F, 0x00, 0x6E, 0x00, 0x73, 0x00, 0x6F, 0x00, 0x72, 0x00, 0x74, 0x00, 0x69, 0x00, 0x75, 0x00, 0x6D, 0x00, 0x2C, 0x00, 0x20, 0x00, 0x32, 0x00, 0x30, 0x00, 0x31, 0x00, 0x37, 0x6D, 0x6C, 0x75, 0x63, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x01, 0x00, 0x00, 0x00, 0x0C, 0x65, 0x6E, 0x55, 0x4B, 0x00, 0x00, 0x00, 0x14, 0x00, 0x00, 0x00, 0x1C, 0x00, 0x44, 0x00, 0x43, 0x00, 0x49, 0x00, 0x20, 0x00, 0x50, 0x00, 0x33, 0x00, 0x20, 0x00, 0x44, 0x00, 0x43, 0x00, 0x49, 0x58, 0x59, 0x5A, 0x20, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0xF6, 0xD5, 0x00, 0x01, 0x00, 0x00, 0x00, 0x00, 0xD3, 0x2D, 0x73, 0x66, 0x33, 0x32, 0x00, 0x00, 0x00, 0x00, 0x00, 0x01, 0x12, 0xE6, 0x00, 0x00, 0x09, 0xEF, 0xFF, 0xFF, 0xF6, 0x8D, 0x00, 0x00, 0x0E, 0x3A, 0x00, 0x00, 0xF6, 0xC8, 0xFF, 0xFF, 0xFC, 0x53, 0xFF, 0xFF, 0xFE, 0xE7, 0x00, 0x00, 0x01, 0x5B, 0x00, 0x00, 0xDC, 0xDF, 0x63, 0x75, 0x72, 0x76, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x01, 0x02, 0x9A, 0x00, 0x00, 0x63, 0x75, 0x72, 0x76, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x01, 0x02, 0x9A, 0x00, 0x00, 0x63, 0x75, 0x72, 0x76, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x01, 0x02, 0x9A, 0x00, 0x00, 0x58, 0x59, 0x5A, 0x20, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x7C, 0x75, 0x00, 0x00, 0x3A, 0x08, 0xFF, 0xFF, 0xFF, 0xCB, 0x58, 0x59, 0x5A, 0x20, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x52, 0xE8, 0x00, 0x00, 0xB5, 0xD8, 0x00, 0x00, 0x0B, 0x11, 0x58, 0x59, 0x5A, 0x20, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x27, 0x79, 0x00, 0x00, 0x10, 0x20, 0x00, 0x00, 0xC8, 0x50, 0x58, 0x59, 0x5A, 0x20, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x30, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00 };
    
    return create(dciP3Data, sizeof(dciP3Data));
}


LCMSColorProfile* fn_nonnull LCMSColorProfile::createDCIP3D65() SWIFT_RETURNS_RETAINED {
    static const unsigned char dciP3D65Data[] = { 0x00, 0x00, 0x02, 0x5C, 0x00, 0x00, 0x00, 0x00, 0x04, 0x30, 0x00, 0x00, 0x6D, 0x6E, 0x74, 0x72, 0x52, 0x47, 0x42, 0x20, 0x58, 0x59, 0x5A, 0x20, 0x07, 0xE1, 0x00, 0x06, 0x00, 0x14, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x61, 0x63, 0x73, 0x70, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x01, 0x00, 0x00, 0xF6, 0xD6, 0x00, 0x01, 0x00, 0x00, 0x00, 0x00, 0xD3, 0x2D, 0x43, 0x49, 0x47, 0x4C, 0x87, 0x78, 0x27, 0x40, 0xF3, 0xE3, 0xD1, 0x78, 0x46, 0x4D, 0x70, 0x67, 0xE9, 0xA2, 0x71, 0xE8, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x0B, 0x63, 0x70, 0x72, 0x74, 0x00, 0x00, 0x01, 0x08, 0x00, 0x00, 0x00, 0x64, 0x64, 0x65, 0x73, 0x63, 0x00, 0x00, 0x01, 0x6C, 0x00, 0x00, 0x00, 0x30, 0x77, 0x74, 0x70, 0x74, 0x00, 0x00, 0x01, 0x9C, 0x00, 0x00, 0x00, 0x14, 0x63, 0x68, 0x61, 0x64, 0x00, 0x00, 0x01, 0xB0, 0x00, 0x00, 0x00, 0x2C, 0x72, 0x54, 0x52, 0x43, 0x00, 0x00, 0x01, 0xDC, 0x00, 0x00, 0x00, 0x10, 0x67, 0x54, 0x52, 0x43, 0x00, 0x00, 0x01, 0xEC, 0x00, 0x00, 0x00, 0x10, 0x62, 0x54, 0x52, 0x43, 0x00, 0x00, 0x01, 0xFC, 0x00, 0x00, 0x00, 0x10, 0x72, 0x58, 0x59, 0x5A, 0x00, 0x00, 0x02, 0x0C, 0x00, 0x00, 0x00, 0x14, 0x67, 0x58, 0x59, 0x5A, 0x00, 0x00, 0x02, 0x20, 0x00, 0x00, 0x00, 0x14, 0x62, 0x58, 0x59, 0x5A, 0x00, 0x00, 0x02, 0x34, 0x00, 0x00, 0x00, 0x14, 0x6C, 0x75, 0x6D, 0x69, 0x00, 0x00, 0x02, 0x48, 0x00, 0x00, 0x00, 0x14, 0x6D, 0x6C, 0x75, 0x63, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x01, 0x00, 0x00, 0x00, 0x0C, 0x65, 0x6E, 0x55, 0x4B, 0x00, 0x00, 0x00, 0x48, 0x00, 0x00, 0x00, 0x1C, 0x00, 0x49, 0x00, 0x6E, 0x00, 0x74, 0x00, 0x65, 0x00, 0x72, 0x00, 0x6E, 0x00, 0x61, 0x00, 0x74, 0x00, 0x69, 0x00, 0x6F, 0x00, 0x6E, 0x00, 0x61, 0x00, 0x6C, 0x00, 0x20, 0x00, 0x43, 0x00, 0x6F, 0x00, 0x6C, 0x00, 0x6F, 0x00, 0x72, 0x00, 0x20, 0x00, 0x43, 0x00, 0x6F, 0x00, 0x6E, 0x00, 0x73, 0x00, 0x6F, 0x00, 0x72, 0x00, 0x74, 0x00, 0x69, 0x00, 0x75, 0x00, 0x6D, 0x00, 0x2C, 0x00, 0x20, 0x00, 0x32, 0x00, 0x30, 0x00, 0x31, 0x00, 0x37, 0x6D, 0x6C, 0x75, 0x63, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x01, 0x00, 0x00, 0x00, 0x0C, 0x65, 0x6E, 0x55, 0x4B, 0x00, 0x00, 0x00, 0x14, 0x00, 0x00, 0x00, 0x1C, 0x00, 0x44, 0x00, 0x43, 0x00, 0x49, 0x00, 0x20, 0x00, 0x50, 0x00, 0x33, 0x00, 0x20, 0x00, 0x44, 0x00, 0x36, 0x00, 0x35, 0x58, 0x59, 0x5A, 0x20, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0xF6, 0xD5, 0x00, 0x01, 0x00, 0x00, 0x00, 0x00, 0xD3, 0x2D, 0x73, 0x66, 0x33, 0x32, 0x00, 0x00, 0x00, 0x00, 0x00, 0x01, 0x0C, 0x44, 0x00, 0x00, 0x05, 0xDF, 0xFF, 0xFF, 0xF3, 0x26, 0x00, 0x00, 0x07, 0x94, 0x00, 0x00, 0xFD, 0x8F, 0xFF, 0xFF, 0xFB, 0xA1, 0xFF, 0xFF, 0xFD, 0xA2, 0x00, 0x00, 0x03, 0xDB, 0x00, 0x00, 0xC0, 0x75, 0x63, 0x75, 0x72, 0x76, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x01, 0x02, 0x9A, 0x00, 0x00, 0x63, 0x75, 0x72, 0x76, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x01, 0x02, 0x9A, 0x00, 0x00, 0x63, 0x75, 0x72, 0x76, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x01, 0x02, 0x9A, 0x00, 0x00, 0x58, 0x59, 0x5A, 0x20, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x83, 0xDF, 0x00, 0x00, 0x3D, 0xBF, 0xFF, 0xFF, 0xFF, 0xBB, 0x58, 0x59, 0x5A, 0x20, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x4A, 0xBF, 0x00, 0x00, 0xB1, 0x37, 0x00, 0x00, 0x0A, 0xB9, 0x58, 0x59, 0x5A, 0x20, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x28, 0x38, 0x00, 0x00, 0x11, 0x0B, 0x00, 0x00, 0xC8, 0xB9, 0x58, 0x59, 0x5A, 0x20, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x30, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00 };
    
    return create(dciP3D65Data, sizeof(dciP3D65Data));
}


struct tag_reader {
    static bool read(cmsHPROFILE profile, cmsCIExyY& component, cmsTagSignature name) {
        if (cmsIsTag(profile, name) == false) {
            return false;
        }
        
        auto tag = cmsReadTag(profile, name);
        if (tag == nullptr) {
            return false;
        }
        
        component = *reinterpret_cast<cmsCIExyY*>(tag);
        return true;
    }
    
    static cmsToneCurve* fn_nullable readToneCurve(cmsHPROFILE profile, cmsTagSignature name) {
        if (cmsIsTag(profile, name) == false) {
            return nullptr;
        }
        
        auto tag = cmsReadTag(profile, name);
        return reinterpret_cast<cmsToneCurve*>(tag);
    }
};


LCMSColorProfile* fn_nullable LCMSColorProfile::createLinear(bool force) SWIFT_RETURNS_RETAINED {
    cmsSetLogErrorHandler([](struct _cmsContext_struct *, unsigned int, const char * message) {
        if (message) {
            printf("Error: %s\n", message);
        }
        else {
            printf("Unknown error\n");
        }
    });
    
    // TODO: This method produces a different colour profile that messes up the colours even if this colour profile is already linear
    
    // Check if the colour profile is already linear
    if (getIsLinear()) {
        printf("Colour profile is already linear\n");
        
        if (force == false) {
            return LCMSColorProfileRetain(this);
        }
    }
    
    // Load lcms color profile
    cmsHPROFILE srcProfile = cmsOpenProfileFromMem(_data, static_cast<cmsUInt32Number>(_size));
    if (srcProfile == nullptr) {
        printf("Could not open ICC profile\n");
        return nullptr;
    }
    
    // Get white point
    cmsCIExyY whitePoint;
    if (tag_reader::read(srcProfile, whitePoint, cmsSigMediaWhitePointTag) == false) {
        printf("Could not read white point tag\n");
        cmsCloseProfile(srcProfile);
        return nullptr;
    }
    
    // Get primaries - retrieve the XYZ colorants (rXYZ, gXYZ, bXYZ)
    cmsCIExyYTRIPLE primaries = { };
    if (tag_reader::read(srcProfile, primaries.Red, cmsSigRedColorantTag) == false) {
        printf("Could not read red colorant tag\n");
        cmsCloseProfile(srcProfile);
        return nullptr;
    }
    if (tag_reader::read(srcProfile, primaries.Green, cmsSigGreenColorantTag) == false) {
        printf("Could not read green colorant tag\n");
        cmsCloseProfile(srcProfile);
        return nullptr;
    }
    if (tag_reader::read(srcProfile, primaries.Blue, cmsSigBlueColorantTag) == false) {
        printf("Could not read green colorant tag\n");
        cmsCloseProfile(srcProfile);
        return nullptr;
    }
    
    // Linear transfer function
    cmsToneCurve* linear = cmsBuildGamma(nullptr, 1.0);
    if (linear == nullptr) {
        printf("Could not create linear gamma\n");
        cmsCloseProfile(srcProfile);
        return nullptr;
    }
    cmsToneCurve* transferFunction[3] = { linear, linear, linear };
    
#if DEBUG
    // Check if the tone curve is linear
    auto isLinear = cmsIsToneCurveLinear(linear);
    if (!isLinear) {
        printf("⚠️ Tone curve that is assumed to be linear is actually not linear\n");
    }
#endif
    
    // Create linear profile
    cmsHPROFILE dstProfile = cmsCreateRGBProfile(&whitePoint, &primaries, transferFunction);
    if (dstProfile == nullptr) {
        printf("Could not create linear ICC profile\n");
        cmsFreeToneCurve(linear);
        cmsCloseProfile(srcProfile);
        return nullptr;
    }
    
    // Prepare for serialisation into memory
    cmsUInt32Number profileSize = 0;
    auto canSave = cmsSaveProfileToMem(dstProfile, nullptr, &profileSize);
    if (canSave == false) {
        printf("Could not prepare ICC profile for serialisation\n");
        cmsCloseProfile(dstProfile);
        cmsFreeToneCurve(linear);
        cmsCloseProfile(srcProfile);
        return nullptr;
    }
    
    // Serialise into memory
    auto profileData = new char[profileSize];
    auto saved = cmsSaveProfileToMem(dstProfile, profileData, &profileSize);
    if (saved == false) {
        printf("Could not serialize ICC profile\n");
        delete [] profileData;
        cmsCloseProfile(dstProfile);
        cmsFreeToneCurve(linear);
        cmsCloseProfile(srcProfile);
        return nullptr;
    }
    
    // Create profile
    auto profile = LCMSColorProfile::create(profileData, profileSize);
    
    // Clean up
    delete [] profileData;
    cmsCloseProfile(dstProfile);
    cmsFreeToneCurve(linear);
    cmsCloseProfile(srcProfile);
    
    // Return profile
    return profile;
}


bool LCMSColorProfile::getIsLinear() {
    // Load lcms color profile
    cmsHPROFILE srcProfile = cmsOpenProfileFromMem(_data, static_cast<cmsUInt32Number>(_size));
    if (srcProfile == nullptr) {
        printf("Could not open ICC profile\n");
        return false;
    }
    
    // Getting TRCs / Tone Curves (gamma)
    auto redTRC = tag_reader::readToneCurve(srcProfile, cmsSigRedTRCTag);
    auto greenTRC = tag_reader::readToneCurve(srcProfile, cmsSigGreenTRCTag);
    auto blueTRC = tag_reader::readToneCurve(srcProfile, cmsSigBlueTRCTag);
    
    // Check if the tone curve is linear
    auto isLinear = redTRC != nullptr && greenTRC != nullptr && blueTRC != nullptr;
    if (isLinear) {
        isLinear = cmsIsToneCurveLinear(redTRC) && cmsIsToneCurveLinear(greenTRC) && cmsIsToneCurveLinear(blueTRC);
    }
    
    cmsCloseProfile(srcProfile);
    
    return isLinear;
}


LCMSColorProfile* fn_nullable LCMSColorProfileRetain(LCMSColorProfile* fn_nullable value) SWIFT_RETURNS_UNRETAINED {
    if (value == nullptr) {
        return nullptr;
    }
    
    value->_referenceCounter.fetch_add(1);
    return value;
}


void LCMSColorProfileRelease(LCMSColorProfile* fn_nullable value) {
    if (value == nullptr) {
        return;
    }
    
    if (value->_referenceCounter.fetch_sub(1) == 1) {
        delete value;
    }
}
